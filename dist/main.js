(()=>{"use strict";var e={77(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.planStructures=function(e){Memory.planning||(Memory.planning={plannedStructures:[],spawnSquareRoadAnchorPositions:[],currentStage:1});const t=Memory.planning;void 0===t.currentStage&&(t.currentStage=1),t.plannedStructures||(t.plannedStructures=[]),t.spawnSquareRoadAnchorPositions||(t.spawnSquareRoadAnchorPositions=[]);const r=t.currentStage,n=e.find(FIND_MY_CONSTRUCTION_SITES).length>0;if(1===r){const r=e.find(FIND_MY_SPAWNS);if(r.length>0){const n=r[0],s=[{dx:-2,dy:0},{dx:2,dy:0},{dx:0,dy:-2},{dx:0,dy:2},{dx:-1,dy:-1},{dx:1,dy:-1},{dx:-1,dy:1},{dx:1,dy:1}];for(const r of s){const s=new RoomPosition(n.pos.x+r.dx,n.pos.y+r.dy,e.name);(0,o.addPlannedStructure)(t.plannedStructures,s,STRUCTURE_ROAD,"to_build",e)&&t.spawnSquareRoadAnchorPositions.push(s)}}const s=t.plannedStructures.filter(e=>e.structureType===STRUCTURE_ROAD&&t.spawnSquareRoadAnchorPositions.some(t=>t.x===e.pos.x&&t.y===e.pos.y));s.length>0&&s.every(e=>"built"===e.status)&&!n&&(console.log("Planner: Stage 1 Complete. Advancing to Stage 2."),t.currentStage=2)}if(2===r){const r=e.find(FIND_MY_SPAWNS);if(0===r.length)return;const s=r[0],a=5;if(e.find(FIND_MY_STRUCTURES,{filter:{structureType:STRUCTURE_EXTENSION}}).length+t.plannedStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION).length<a)for(const r of t.spawnSquareRoadAnchorPositions){if(t.plannedStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION).length>=a)break;const n=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(const i of n){const n=new RoomPosition(r.x+i.dx,r.y+i.dy,e.name);if(e.getTerrain().get(n.x,n.y)!==TERRAIN_MASK_WALL&&!n.isEqualTo(s.pos)&&!t.plannedStructures.some(e=>e.pos.x===n.x&&e.pos.y===n.y)&&(0,o.addPlannedStructure)(t.plannedStructures,n,STRUCTURE_EXTENSION,"to_build",e)&&t.plannedStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION).length>=a)break}}const i=t.plannedStructures.filter(e=>e.structureType===STRUCTURE_EXTENSION);i.length>=5&&i.every(e=>"built"===e.status)&&!n&&(console.log("Planner: Stage 2 Complete. Advancing to Stage 3."),t.currentStage=3)}if(3===r){const r=e.find(FIND_SOURCES).filter(e=>(0,o.isSourceSafe)(e)),s=t.spawnSquareRoadAnchorPositions;if(s.length>0){console.log(`Planner Stage 3: Planning roads for ${r.length} sources.`);for(const n of r){const r=(0,o.findClosestAnchor)(n.pos,s);if(r){const s=PathFinder.search(n.pos,{pos:r,range:1},{plainCost:2,swampCost:10,roomCallback:r=>{const o=new PathFinder.CostMatrix;return e.find(FIND_STRUCTURES).forEach(e=>{e.structureType!==STRUCTURE_ROAD&&o.set(e.pos.x,e.pos.y,255)}),t.plannedStructures.forEach(e=>{e.structureType===STRUCTURE_ROAD&&o.set(e.pos.x,e.pos.y,1)}),o}});if(!s.incomplete)for(const r of s.path)(0,o.addPlannedStructure)(t.plannedStructures,r,STRUCTURE_ROAD,"to_build",e)}}}const a=t.plannedStructures.filter(e=>e.structureType===STRUCTURE_ROAD&&!t.spawnSquareRoadAnchorPositions.some(t=>t.x===e.pos.x&&t.y===e.pos.y));a.length>0?a.every(e=>"built"===e.status)&&!n&&(console.log("Planner: Stage 3 Complete. Advancing to Stage 4."),t.currentStage=4):r.length>0&&console.log("Planner Stage 3: No road positions added. Check PathFinder or terrain constraints.")}if(4===r){const r=e.controller;if(!r)return;const s=t.spawnSquareRoadAnchorPositions,a=(0,o.findClosestAnchor)(r.pos,s);if(a){const n=PathFinder.search(r.pos,{pos:a,range:1},{plainCost:2,swampCost:10,roomCallback:t=>{const r=new PathFinder.CostMatrix;return e.find(FIND_STRUCTURES).forEach(e=>{e.structureType!==STRUCTURE_ROAD&&r.set(e.pos.x,e.pos.y,255)}),r}}).path;for(const r of n)(0,o.addPlannedStructure)(t.plannedStructures,r,STRUCTURE_ROAD,"to_build",e)}0!==t.plannedStructures.filter(e=>!t.spawnSquareRoadAnchorPositions.some(t=>t.x===e.pos.x&&t.y===e.pos.y)&&"built"!==e.status).length||n||(console.log("Planner: Stage 4 Complete."),t.currentStage=5)}};const o=r(623)},119(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.runBuilder=function(e){if(e.memory.building&&0===e.store[RESOURCE_ENERGY]&&(e.memory.building=!1,delete e.memory.targetId),e.memory.building||0!==e.store.getFreeCapacity()||(e.memory.building=!0,delete e.memory.targetId),e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t&&0!==(0,o.getEnergyAmount)(t)||delete e.memory.targetId}if(e.memory.building){if(!e.memory.targetId){const t=e.pos.findClosestByPath(FIND_MY_CONSTRUCTION_SITES);t&&(e.memory.targetId=t.id)}if(e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t?e.build(t)===ERR_NOT_IN_RANGE?e.moveTo(t,{visualizePathStyle:{stroke:"#ffffff"},reusePath:10}):e.say("üî®"):delete e.memory.targetId}else e.upgradeController(e.room.controller)===ERR_NOT_IN_RANGE?e.moveTo(e.room.controller,{reusePath:10}):e.say("‚ö°")}else{if(!e.memory.targetId){const t=e.room.storage;if(t&&t.store[RESOURCE_ENERGY]>0&&(0,o.isTargetAvailable)(e,t)&&(e.memory.targetId=t.id),!e.memory.targetId){const t=e.pos.findClosestByPath(FIND_STRUCTURES,{filter:t=>t.structureType===STRUCTURE_CONTAINER&&t.store[RESOURCE_ENERGY]>50&&(0,o.isTargetAvailable)(e,t)});t&&(e.memory.targetId=t.id)}if(!e.memory.targetId){const t=e.pos.findClosestByPath(FIND_DROPPED_RESOURCES,{filter:t=>t.resourceType===RESOURCE_ENERGY&&t.amount>50&&(0,o.isTargetAvailable)(e,t)});t&&(e.memory.targetId=t.id)}}if(e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t&&((t instanceof Resource?e.pickup(t):e.withdraw(t,RESOURCE_ENERGY))===ERR_NOT_IN_RANGE?e.moveTo(t,{visualizePathStyle:{stroke:"#ffaa00"},reusePath:10}):e.say("üì¶"))}else e.say("üí§")}};const o=r(623)},978(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.runHarvester=function(e){const t=e.room;if(!e.memory.sourceId){const r=t.find(FIND_SOURCES),n=_.filter(r,e=>(0,o.isSourceSafe)(e));if(n.length>0){const r=_.filter(Game.creeps,r=>r.room.name===t.name&&"harvester"===r.memory.role&&r.name!==e.name);for(const t of n)if(_.filter(r,e=>e.memory.sourceId===t.id).length<2){e.memory.sourceId=t.id,e.say("‚õèÔ∏è",!0);break}}}const r=Game.getObjectById(e.memory.sourceId);if(r)if(e.store.getFreeCapacity()>0)e.harvest(r)===ERR_NOT_IN_RANGE&&e.moveTo(r,{visualizePathStyle:{stroke:"#ffaa00"}});else if(0===_.filter(Game.creeps,e=>e.room.name===t.name&&"supplier"===e.memory.role&&!e.spawning).length){const r=e.pos.findClosestByPath(FIND_MY_STRUCTURES,{filter:e=>(e.structureType===STRUCTURE_SPAWN||e.structureType===STRUCTURE_EXTENSION)&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0});r?e.transfer(r,RESOURCE_ENERGY)===ERR_NOT_IN_RANGE&&e.moveTo(r,{visualizePathStyle:{stroke:"#ffffff"}}):e.upgradeController(t.controller)===ERR_NOT_IN_RANGE&&e.moveTo(t.controller)}else{const t=e.pos.findInRange(FIND_MY_STRUCTURES,3,{filter:e=>e.structureType===STRUCTURE_LINK&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0})[0];if(t)e.transfer(t,RESOURCE_ENERGY)===ERR_NOT_IN_RANGE&&e.moveTo(t);else{const t=e.pos.findInRange(FIND_STRUCTURES,3,{filter:e=>e.structureType===STRUCTURE_CONTAINER&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0})[0];t?e.transfer(t,RESOURCE_ENERGY)===ERR_NOT_IN_RANGE&&e.moveTo(t):e.drop(RESOURCE_ENERGY)}}else delete e.memory.sourceId};const o=r(623)},594(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.runSupplier=function(e){const t=e.room;if(0!==e.getActiveBodyparts(WORK)){if(e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t&&0!==(0,o.getEnergyAmount)(t)?(0===e.store.getFreeCapacity()&&(t instanceof Resource||t instanceof StructureContainer||t instanceof StructureLink||t instanceof StructureStorage)||0===e.store.getUsedCapacity())&&delete e.memory.targetId:delete e.memory.targetId}if(0===e.store.getUsedCapacity()){if(!e.memory.targetId){const r=t.find(FIND_SOURCES),n=t.find(FIND_STRUCTURES,{filter:t=>(t.structureType===STRUCTURE_CONTAINER||t.structureType===STRUCTURE_LINK)&&r.some(e=>t.pos.inRangeTo(e,3))&&(0,o.isTargetAvailable)(e,t)});if(n.length>0){const t=e.pos.findClosestByPath(n);t&&(e.memory.targetId=t.id)}if(!e.memory.targetId){const t=e.pos.findClosestByPath(FIND_DROPPED_RESOURCES,{filter:t=>t.resourceType===RESOURCE_ENERGY&&(0,o.isTargetAvailable)(e,t)});t&&(e.memory.targetId=t.id)}!e.memory.targetId&&t.storage&&(0,o.isTargetAvailable)(e,t.storage)&&t.storage.store[RESOURCE_ENERGY]>500&&(e.memory.targetId=t.storage.id)}if(e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t&&((t instanceof Resource?e.pickup(t):e.withdraw(t,RESOURCE_ENERGY))===ERR_NOT_IN_RANGE?e.moveTo(t,{visualizePathStyle:{stroke:"#ffaa00"},reusePath:10}):e.say("üì¶"))}else e.say("üí§")}else{if(!e.memory.targetId){let r=e.pos.findClosestByPath(FIND_MY_STRUCTURES,{filter:e=>(e.structureType===STRUCTURE_SPAWN||e.structureType===STRUCTURE_EXTENSION)&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0});if(!r){const o=t.find(FIND_SOURCES);r=e.pos.findClosestByPath(FIND_STRUCTURES,{filter:e=>{const t=e.structureType===STRUCTURE_CONTAINER,r=!o.some(t=>e.pos.inRangeTo(t,3));return t&&r&&e.store.getFreeCapacity(RESOURCE_ENERGY)>0}})}r&&(e.memory.targetId=r.id)}if(e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t&&t.store&&t.store.getFreeCapacity(RESOURCE_ENERGY)>0?e.transfer(t,RESOURCE_ENERGY)===ERR_NOT_IN_RANGE?e.moveTo(t,{visualizePathStyle:{stroke:"#ffffff"},reusePath:10}):e.say("üì•"):delete e.memory.targetId}else{const r=e.pos.findClosestByPath(FIND_STRUCTURES,{filter:e=>e.hits<e.hitsMax&&e.structureType!==STRUCTURE_WALL&&e.structureType!==STRUCTURE_RAMPART});if(r)return void(e.repair(r)===ERR_NOT_IN_RANGE?e.moveTo(r):e.say("üîß"));const o=e.pos.findClosestByPath(FIND_MY_CONSTRUCTION_SITES);if(o)return void(e.build(o)===ERR_NOT_IN_RANGE?e.moveTo(o):e.say("üî®"));e.upgradeController(t.controller)===ERR_NOT_IN_RANGE?e.moveTo(t.controller):e.say("‚ö°")}}}else e.suicide()};const o=r(623)},180(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.runUpgrader=function(e){if(e.memory.upgrading&&0===e.store[RESOURCE_ENERGY]&&(e.memory.upgrading=!1,delete e.memory.targetId),e.memory.upgrading||0!==e.store.getFreeCapacity()||(e.memory.upgrading=!0,delete e.memory.targetId),e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t&&0!==(0,o.getEnergyAmount)(t)||delete e.memory.targetId}if(e.memory.upgrading)e.upgradeController(e.room.controller)===ERR_NOT_IN_RANGE?e.moveTo(e.room.controller,{visualizePathStyle:{stroke:"#ffffff"}}):e.say("‚ö°");else{if(!e.memory.targetId){const t=e.room.controller.pos.findInRange(FIND_STRUCTURES,3,{filter:t=>t.structureType===STRUCTURE_CONTAINER&&t.store[RESOURCE_ENERGY]>0&&(0,o.isTargetAvailable)(e,t)})[0];if(t&&(e.memory.targetId=t.id),!e.memory.targetId&&e.room.storage&&(0,o.isTargetAvailable)(e,e.room.storage)&&e.room.storage.store[RESOURCE_ENERGY]>0&&(e.memory.targetId=e.room.storage.id),!e.memory.targetId){const t=e.pos.findClosestByPath(FIND_STRUCTURES,{filter:t=>t.structureType===STRUCTURE_CONTAINER&&t.store[RESOURCE_ENERGY]>50&&(0,o.isTargetAvailable)(e,t)});t&&(e.memory.targetId=t.id)}if(!e.memory.targetId){const t=e.pos.findClosestByPath(FIND_DROPPED_RESOURCES,{filter:t=>t.resourceType===RESOURCE_ENERGY&&t.amount>50&&(0,o.isTargetAvailable)(e,t)});t&&(e.memory.targetId=t.id)}}if(e.memory.targetId){const t=Game.getObjectById(e.memory.targetId);t&&((t instanceof Resource?e.pickup(t):e.withdraw(t,RESOURCE_ENERGY))===ERR_NOT_IN_RANGE?e.moveTo(t,{visualizePathStyle:{stroke:"#ffaa00"},reusePath:10}):e.say("üì¶"))}else{if(e.room.controller.level<=2){const t=e.pos.findClosestByPath(FIND_SOURCES,{filter:e=>e.energy>0});if(t)return void(e.harvest(t)===ERR_NOT_IN_RANGE?e.moveTo(t,{visualizePathStyle:{stroke:"#ffaa00"}}):e.say("‚õèÔ∏è"))}e.say("üí§")}}};const o=r(623)},623(e,t){function r(e,t){if(!e||!e.roomName||e.x<0||e.y<0||e.x>=50||e.y>=50)return!1;if(t.getTerrain().get(e.x,e.y)===TERRAIN_MASK_WALL)return!1;const r=t.lookAt(e);for(const e of r){if(e.structure&&e.structure.structureType!==STRUCTURE_ROAD)return!1;if(e.constructionSite&&e.constructionSite.structureType!==STRUCTURE_ROAD)return!1}return!0}function o(e){return e?e.store?e.store.getUsedCapacity(RESOURCE_ENERGY):e.amount?e.amount:0:0}Object.defineProperty(t,"__esModule",{value:!0}),t.isTerrainValidForRoad=r,t.addPlannedStructure=function(e,t,o,n="to_build",s){return!e.some(e=>e.pos.x===t.x&&e.pos.y===t.y&&e.structureType===o)&&!!r(t,s)&&(e.push({pos:t,structureType:o,status:n}),!0)},t.findClosestAnchor=function(e,t){if(0===t.length)return null;let r=null,o=1/0;for(const n of t){const t=e.getRangeTo(n);t<o&&(o=t,r=n)}return r},t.isSourceSafe=function(e){return!(e.pos.findInRange(FIND_HOSTILE_CREEPS,10).length>0)&&!(e.pos.findInRange(FIND_HOSTILE_STRUCTURES,10,{filter:e=>e.owner&&"Invader"!==e.owner.username&&"Source Keeper"!==e.owner.username}).length>0)},t.generateBody=function(e,t){let r=[];if("harvester"===e){let e=Math.floor((t-100)/100);e>6&&(e=6),e<1&&(e=1);for(let t=0;t<e;t++)r.push(WORK);r.push(CARRY),r.push(MOVE)}else if("supplier"===e){r.push(WORK);let e=t-100,o=Math.floor(e/100);o>15&&(o=15),o<1&&(o=1);for(let e=0;e<o;e++)r.push(CARRY),r.push(CARRY),r.push(MOVE)}else{let e=Math.floor(t/200);e>15&&(e=15),e<1&&(e=1);for(let t=0;t<e;t++)r.push(WORK),r.push(CARRY),r.push(MOVE)}return r},t.getEnergyAmount=o,t.isTargetAvailable=function(e,t){if(!t)return!1;let r=o(t);if(r<=0)return!1;const n=_.filter(Game.creeps,r=>r.room.name===e.room.name&&r.id!==e.id&&r.memory.targetId===t.id);let s=0;for(const e of n)s+=e.store.getFreeCapacity(RESOURCE_ENERGY);return r-s>0}}},t={};function r(o){var n=t[o];if(void 0!==n)return n.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,r),s.exports}var o={};(()=>{var e=o;Object.defineProperty(e,"__esModule",{value:!0}),e.loop=void 0;const t=r(77),n=r(978),s=r(594),a=r(119),i=r(180),l=r(623);console.log("--- GEMINI DEPLOY: v29 (Stage 3 Debug) ---"),e.loop=function(){for(const e in Memory.creeps)Game.creeps[e]||delete Memory.creeps[e];let e=Object.values(Game.rooms)[0];if(!e){const t=Object.values(Game.spawns);t.length>0&&(e=t[0].room)}if(!e)return;if(Memory.planning&&Memory.planning.plannedStructures)for(const e of Memory.planning.plannedStructures){if("built"===e.status)continue;const t=new RoomPosition(e.pos.x,e.pos.y,e.pos.roomName);t.lookFor(LOOK_STRUCTURES).some(t=>t.structureType===e.structureType)?e.status="built":e.status=t.lookFor(LOOK_CONSTRUCTION_SITES).length>0?"building":"to_build"}if((0,t.planStructures)(e),Memory.planning&&Memory.planning.plannedStructures){const t=Memory.planning.plannedStructures.filter(e=>"to_build"===e.status);for(const r of t){const t=e.createConstructionSite(r.pos.x,r.pos.y,r.structureType);t===OK?(r.status="building",console.log(`Main: Successfully created CS for ${r.structureType} at ${r.pos.x},${r.pos.y}`)):t!==ERR_FULL&&console.log(`Main: FAILED to create CS for ${r.structureType} at ${r.pos.x},${r.pos.y}. Error: ${t}`)}}const r=e.find(FIND_MY_SPAWNS)[0];if(r&&!r.spawning){const t=_.filter(Game.creeps,t=>t.room.name===e.name),o=_.filter(t,e=>"harvester"===e.memory.role),n=_.filter(t,e=>"supplier"===e.memory.role),s=_.filter(t,e=>"builder"===e.memory.role),a=_.filter(t,e=>"upgrader"===e.memory.role),i=e.find(FIND_SOURCES),u=_.filter(i,e=>(0,l.isSourceSafe)(e)),c=e.controller?e.controller.level:1,R=e.find(FIND_MY_CONSTRUCTION_SITES).length>0,d=o[0],m=(d?_.filter(d.body,e=>e.type===WORK).length:0)<5?2*u.length:u.length,f=Math.max(1,o.length+1),E=R?c<=2?2:1:0,y=c<=3?2:1,p=0===o.length?e.energyAvailable:e.energyCapacityAvailable;let g=null;if(o.length<u.length?g="harvester":n.length<1?g="supplier":a.length<1?g="upgrader":o.length<m?g="harvester":s.length<E?g="builder":n.length<f?g="supplier":a.length<y&&(g="upgrader"),g){const t=(0,l.generateBody)(g,p);let o=0;for(const e of t)o+=BODYPART_COST[e];e.energyAvailable>=o&&r.spawnCreep(t,g.charAt(0).toUpperCase()+g.slice(1)+Game.time,{memory:{role:g}})}}for(const e in Game.creeps){const t=Game.creeps[e];t.spawning||("harvester"===t.memory.role?(0,n.runHarvester)(t):"builder"===t.memory.role?(0,a.runBuilder)(t):"supplier"===t.memory.role?(0,s.runSupplier)(t):"upgrader"===t.memory.role&&(0,i.runUpgrader)(t))}}})();var n=exports;for(var s in o)n[s]=o[s];o.__esModule&&Object.defineProperty(n,"__esModule",{value:!0})})();